<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <link rel='shortcut icon' type='image/x-icon' href='/favicon.ico' />
	<title>The Giant Outdoors</title>
	
  <link href="bootstrap3/css/bootstrap.css" rel="stylesheet" />
	<link href="assets/css/get-shit-done.css" rel="stylesheet" />
  <link href="assets/css/giantoutdoors.css" rel="stylesheet" />
    
  <!--     Font Awesome     -->
  <link href="bootstrap3/css/font-awesome.css" rel="stylesheet">

  <!--    Leaflet     -->
  <link rel="stylesheet" href="assets/css/leaflet.css" />
  <link rel="stylesheet" href="assets/css/leaflet.label.css" />

  <script src="assets/js/leaflet-src.js"></script>
  <script src="assets/js/leaflet.label.js"></script>
  <script src="assets/js/oms.min.js"></script>

</head>
<body>
  <div class="intro">
<!--     <video id="video" src="assets/video/intro.mp4"></video>
 -->    <a class="close btn btn-info btn-fill">Skip</a>
  </div>
  <div class="row1">
      <div class="logoholder">
        <img class="logo" src="assets/img/logo-wide.png"/>
      </div>
      <div class="col-md-6 modebuttons btn-group">
              <a href="#" id="btnexplore" class="btn btn-info btnswitch" data-toggle="tooltip" data-placement="bottom" title="" data-original-title="Explore the area">
<!--                     <img src="assets/img/wellies.png"/>
-->                    Explore
              </button>
              <a href="#" id="btndig" class="btn btn-info btn-fill btnswitch" data-toggle="tooltip" data-placement="bottom" title="" data-original-title="Dig down through history"><!--                     <img src="assets/img/spade.png"/>
-->Dig
              </button>
              <a href="mailto:example@thegiantoutdoors.org?subject=Add your story&body=my history..." class="btn btn-info btn-fill" data-toggle="tooltip" data-placement="bottom" title="" data-original-title="Add your own history">
<!--                     <img src="assets/img/camera.png"/>
-->                    Add
              </a>
      </div>
      <div class="maplayerbuttons btn-group">
          <button href="#fakelink" class="btn-tilelayer btn btn-info btn-fill">Map</button>
          <button href="#fakelink" class="btn-tilelayer btn btn-info">Satellite</button>
          <button href="#fakelink" class="btn-tilelayer btn btn-info btn-fill" data-toggle="tooltip" data-placement="bottom" title="" data-original-title="1888-1913 OS map">Old OS</button>
      </div>
  </div>
  <div id="contentholder">
    
    <div id="mapdiv">
      <div id="sliderholder">
        <div id="slidertitle"><div class="inner"></div></div>
        <div id="slider2" data-toggle="popover" data-placement="top" ></div>
        <!-- title="Date" data-content="And here's some amazing content. It's very engaging. Right?" -->
        <!-- data-toggle="tooltip" data-placement="top" title="Display date whilst dragging or hovering" -->
        <div class="epochholder">
        </div>
      </div>
    </div>

    <div id="walkholder">
      <a class="leaflet-popup-close-button" href="#close">Ã—</a>
      <h3 class="title"></h3>
      <img class="photo"/>
      <h4 class="subtitle"></h4>
      <p class="description"></p>
      <span class="infotitle">Start: </span><span class="start info"></span>
      <span class="infotitle">End: </span><span class="end info"></span>
      <span class="infotitle">Parking: </span><span class="parking info"></span>
      <span class="infotitle">Difficulty: </span><span class="difficulty info"></span>
      <span class="infotitle">KML: </span><span class="info"> <a class="info kml" href="">Download</a></span>
      <span class="infotitle">GPX: </span><span class="info"> <a class="info gpx" href="">Download</a></span>
    </div>

  </div>
</body>
  <script src="jquery/jquery-1.10.2.js" type="text/javascript"></script>
	<script src="assets/js/jquery-ui-1.10.4.custom.min.js" type="text/javascript"></script>

	<script src="bootstrap3/js/bootstrap.js" type="text/javascript"></script>
  <script src="assets/js/easing.js"></script>

  <script src="assets/js/custom.js"></script>
  <script src="assets/js/intro.js"></script>
  <script src="assets/js/map.js"></script>
  <script src="assets/js/timeline.js"></script>

  <script src="assets/json/dates.json"></script>
  <script src="assets/geojson/walk1.geojson"></script>
  <script src="assets/geojson/walk2.geojson"></script>
  <script src="assets/geojson/data.geojson"></script>

  <script type="text/javascript">
    $(function(){

      $("#walkholder .leaflet-popup-close-button").click(function(){
        $("#walkholder").hide();
      });

      //$('[data-toggle="popover"]').popover('show');

      $("#btndig, #btnexplore").click(function(){
        $(".btnswitch").addClass("btn-fill");
        $(this).removeClass("btn-fill");
        if($(this).attr('id') == "btndig"){
          mapm.switchModes("dig");
        } else {//Explore
          mapm.switchModes("explore");
          showHideMarkers();
        }
      });

      $("#slider2").slider({
        orientation: "horizontal",
        range: "min",
        min: 0,
        max: 100,
        value: 100,
        change: function( event, ui ) {
          sliderUpdater(ui.value);
        },
        slide: function( event, ui ) {
          sliderUpdater(ui.value);
        }
      });

      // $("#slider2").slider(
      //   'value',
      //   $("#slider2").slider('value')
      // );

      function sliderUpdater(val){
          var epoch = getEpochFromPercent(val, epochData);

          $("#slidertitle .inner").html(epoch['name'] + ' ' + epoch.dateStart + ' - ' + epoch.dateEnd + " <i data-original-title class=\"fa fa-info-circle\" data-toggle=\"popover\" data-trigger=\"hover\" title=\"" + epoch.name + "\" data-content=\"" + epoch.description + "\" data-placement=\"top\"></i>");
          //$('i').popover();

          var range = [epoch.dateStart, epoch.dateEnd];
          //Get epoch from lookup

          //Range needs to be from +1 to -1
          showHideMarkers(range);
      }

      window.sliderUpdater = sliderUpdater;

      function getEpochFromPercent(perc, epochs){
        var epochi = 0;
          while(epochi < epochs.length){
            if(perc <= epochs[epochi].percentageStart && perc >= epochs[epochi].percentageEnd){
              return epochs[epochi];
            }
            epochi++;
          }
        return epochs[0];
      }

      $('#sliderholder').mousedown(function(e){
        return false;
      });

    });//Jquery ready function
         
    //- - - - - - - Surround with logic - - - - - - - - - - -
    //introVideo.play();
    //introVideo.onEnd(function(){
    //});

    var markers;
    function initMap(){
      mapm.init();
      loadMarkers();
      //showHideMarkers();

      mapm.oms.addListener('click', omsClickHandler);

      //Add walks layer
      mapm.layers.walks = L.layerGroup();
      addWalkLayers(mapm.layers.walks);

      //setTimeout(function(){
        mapm.switchModes('explore');//Set up default page
        showHideMarkers();
      //},0)

    }

    function addWalkLayers (walkLGrp) {
      function walkClicked(marker){
        var props = marker.target.feature.properties;
        $("#walkholder").show();
        $("#walkholder .title").text(props.title);
        $("#walkholder .subtitle").text(props.subtitle);
        $("#walkholder .description").text(props.description);
        $("#walkholder .start").text(props.start);
        $("#walkholder .end").text(props.end);
        $("#walkholder .parking").text(props.parking);
        $("#walkholder .photo").attr("src", "assets/content/" + props.photo);
        $("#walkholder .difficulty").text(props.difficulty);
        $("#walkholder .gpx").attr("href","assets/geojson/" + props.gpx);
        $("#walkholder .kml").attr("href", "assets/geojson/" + props.kml);
        this.feature.properties;
      }

      function onEachWalk(feature, layer) {
          layer.bindLabel(feature.properties.title);
          layer.on('click', walkClicked);
      }

      walkLGrp.addLayer(
       L.geoJson(walk1, {
        style: {
          color: '#f00',
          weight: 10,
          opacity: 0.1
        },
        onEachFeature: onEachWalk
      }));

      walkLGrp.addLayer(
       L.geoJson(walk1, {
        style: {
          color: '#f00',
          weight: 2,
          opacity: 1
        },
        onEachFeature: onEachWalk
      }));

      walkLGrp.addLayer(
       L.geoJson(walk2, {
        style: {
          color: '#f00',
          weight: 10,
          opacity: 0.1
        },
        onEachFeature: onEachWalk
      }));

      walkLGrp.addLayer(
       L.geoJson(walk2, {
        style: {
          color: '#f00',
          weight: 2,
          opacity: 1
        },
        onEachFeature: onEachWalk
      }));
    }

    function omsClickHandler(marker) {
      //Show element
      if (marker.feature.properties) {
        var props = marker.feature.properties;
        var htmlString = "";
        var extraProps = {};
        if(props.Sketchfab){
          htmlString += "<iframe width=\"400\" height=\"300\" src=\"https://sketchfab.com/models/c54559a8309f4a0297be7e21b11dd8c6/embed\" frameborder=\"0\" allowfullscreen mozallowfullscreen=\"true\" webkitallowfullscreen=\"true\" onmousewheel=\"\"></iframe>\
            <p style=\"font-size: 13px; font-weight: normal; margin: 5px; color: #4A4A4A;\">\
                <a href=\"https://sketchfab.com/models/c54559a8309f4a0297be7e21b11dd8c6\" target=\"_blank\" style=\"font-weight: bold; color: #1CAAD9;\">View on Sketchfab</a>\
            </p>";
          extraProps.className = "wide-popup"
        } else if(props.Image && props.Image != undefined){
          htmlString += "<img class='width100' src='assets/content/" + props.Image + "'/>";
        }
        htmlString += "<h4>" + props.Title + "</h4>" +
            "<p>" + props.Description + "</p>";
        if(props.URL){
          htmlString += "<a href=" + props.URL + " target=\"_BLANK\">find out more...</a>";
        }
        if(props.Tags){
          htmlString += "<div class=\"tags\">";
            for (var i = props.Tags.length - 1; i >= 0; i--) {
              htmlString += "<span>" + props.Tags[i] + "</span>";
            };
          htmlString += "</div>";
        }
        var popup = new L.popup(extraProps);
        popup.setContent(htmlString);
        popup.setLatLng(marker.getLatLng());
        mapm.map.openPopup(popup);
        // layer.bindPopup(
        //   htmlString,
        //   extraProps
        //   //feature.properties.popupContent
        // );
      }
    }

    $(function () {
      $('[data-toggle="tooltip"]').tooltip()
    });

    $('.btn-tooltip').tooltip();
    $('.label-tooltip').tooltip();
    $('.pick-class-label').click(function(){
        var new_class = $(this).attr('new-class');  
        var old_class = $('#display-buttons').attr('data-class');
        var display_div = $('#display-buttons');
        if(display_div.length) {
          var display_buttons = display_div.find('.btn');
          display_buttons.removeClass(old_class);
          display_buttons.addClass(new_class);
          display_div.attr('data-class', new_class);
        }
    });    

    function loadMarkers(){
      //Define marker icons that can be used
      var markerIcons = {};
      markerIcons.orange = L.icon({
        iconUrl: 'assets/img/marker-orange.png',
        iconRetinaUrl: 'assets/img/marker-orange-2x.png',
        shadowUrl: 'assets/img/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [0, 0]
      });

      markerIcons.brown = L.icon({
        iconUrl: 'assets/img/marker-brown.png',
        iconRetinaUrl: 'assets/img/marker-brown-2x.png',
        shadowUrl: 'assets/img/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [0, 0]
      });

      markerIcons.green = L.icon({
        iconUrl: 'assets/img/marker-green.png',
        iconRetinaUrl: 'assets/img/marker-green-2x.png',
        shadowUrl: 'assets/img/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [0, 0]
      });

      markers = L.geoJson(data, {
        pointToLayer: function (feature, latlng) {
          switch (feature.properties["Marker Type"]) {
            //find
            //other site
            //
            case 'other site':
              return L.marker(latlng, {icon: markerIcons.orange});
            case 'find':
              return L.marker(latlng, {icon: markerIcons.brown});
            case 'plant' :
              return L.marker(latlng, {icon: markerIcons.green});
            case 'key site' :
              return L.marker(latlng, {icon: markerIcons.brown});
          }
          return L.marker(latlng, {icon: markerIcons.orange});

        }
      });
    }


    function showHideMarkers(dates){
      mapm.oms.clearMarkers();
      for (var ma in markers._layers) {
        mapm.map.removeLayer(markers._layers[ma]);//Remove stale markers
        //Filter
        if(filterMarker(dates, markers._layers[ma])){
          markers._layers[ma].addTo(mapm.map);
          mapm.oms.addMarker(markers._layers[ma]);
        }
      }
    }

    function filterMarker(dates, feature){
      feature = feature.feature;
      var props = feature.properties
      if(typeof dates != 'object'){
        return true;
      }
      if(props.StartDate <= dates[1] && dates[0] <= props.EndDate){
        return true;
      } else {
        return false;
      }
    }

    $(".btn-tilelayer").click(function(){
      mapm.map.removeLayer(mapm.layers["satellite"]);
      mapm.map.removeLayer(mapm.layers["road"]);
      mapm.map.removeLayer(mapm.layers["old"]);
      if($(this)[0].textContent == "Satellite"){
        mapm.map.addLayer(mapm.layers["satellite"]);
      } else if($(this)[0].textContent == "Map") {
        mapm.map.addLayer(mapm.layers["road"]);
      } else {
        mapm.map.addLayer(mapm.layers["old"]);
      }

      $(".btn-tilelayer").addClass("btn-fill");//Add class to all buttons
      $(this).removeClass('btn-fill');//Remove class from this button
    });


    //Start it all off
    window.setTimeout(initMap, 0);
</script>
</html>